# 同轴电缆长度与终端负载检测装置

​	本仓库用于存放2023年电赛B题（同轴电缆长度与终端负载检测装置）的软件程序。



## 一、总体思路

### 1.同轴电缆长度测量

#### ① 初步思路

​	方波信号输入同轴电缆，会产生反射现象，我们能够在信号输入端观察到两段式阶梯波。通过使用不同长度的电缆实验可得，阶梯宽度与电缆长度呈现正相关。

​	我们使用STM32向同轴电缆输入连续方波信号，将所得反射信号（阶梯波）通过电压阈值分别为两级阶梯上升电压中点的TLV3501比较器，得到两路下降沿。

​	将两路下降沿输入FPGA，4个相位时钟两两差开90度分别给计数器计数。将时钟倍频至250M，每个计数分辨率就是4ns。把四个相位的计数器的结果相加，得到精度为1ns的计数器结果。由于20m的电缆反射产生的阶梯波宽度约为200ns，四个相位的计数器的结果相加的和不会超过255，因而选择通过8个IO口直接并行输出。

​	使用STM32的8个IO读取FPGA的输出，二进制转十进制即得两路下降沿间隔时间。更换不同长度的电缆，记录电缆长度与对应时间差数据，根据散点拟合 “电缆长度y <---> 阶梯宽度（时间差）x” 对应关系（近似为一次函数），写入STM32程序中。这样，STM32通过拟合出的对应关系，根据时间差推算出当前电缆长度，显示在OLED上供查看。

​	系统框图如下。其中，STM32F103C8T6+50Ω是为了模拟具有50Ω输出电阻的信号发生器。阶梯波可从50Ω与SMA母座之间由示波器读出。

![image-20250715165522505](https://raw.githubusercontent.com/undefined-0/image-store/main/PicGo/202507151658709.png)

​	仿真电路图如下。（注：LMV358作为跟随器，其实可以去掉。最左侧四个电阻起分压作用，参数可调。本图中，输入LMV358的3脚和5脚的电压应分别调节为两级阶梯波上升电压中点。）

![image-20250716092917189](https://raw.githubusercontent.com/undefined-0/image-store/main/PicGo/202507162201318.png)

​	时序图如下。

![时序图](https://raw.githubusercontent.com/undefined-0/image-store/main/PicGo/202507151940528.png)

#### ② 问题

i. 测试发现，STM32的方波输出IO连接洞洞板上的负载时，测试发现输入TLV3501的方波高电平由3.3V被拉低至2.26V左右（即便是在推挽输出的情况下）。这是由于STM32的IO口最大输出电流仅25mA，带负载能力不足。

![image-20250716092026857](https://raw.githubusercontent.com/undefined-0/image-store/main/PicGo/202507162201319.png)

ii. 测试较短的电缆长度（如1m）时，两路下降沿的时间差过短，FPGA常会发生误判——计算相邻周期而非同一周期的两路下降沿间隔。

针对上述两个问题，我们改进电路。让STM32输出的激励方波先经过一个比较器以维持电压，再经50Ω以模拟信号发生器。输入FPGA的两路信号由两路比较器的输出变为STM32经处理（经过比较器与50Ω）后的激励信号与一路比较器的输出。这样一来，两路信号的时间差被拉大，减小了FPGA误判的可能性。

改进后的系统框图如下：

### 2.同轴电缆终端负载测量

……



## 二、STM32F103C8T6接线方法：

* 四线0.96寸OLED屏幕

  * PB7 - I2C1 SDA

  * PB6 - I2C1 SCL

  * 3V3、GND两根电源线


* 外部按键输入

  * PB8 - Length

  * PB9 - Load


* 频率200kHz，占空比50%的方波激励信号输出

  * PA8（TIM1-Channel1）


* FPGA计数结果输入

  * PA0-PA7这8个IO口接FPGA的8个数据输出IO口
    * PA7 是最高有效位（MSB），PA0 是最低有效位（LSB）。

      > PA7 → bit7
      > PA6 → bit6
      > ...
      > PA0 → bit0

* 利用ADC+串联分压原理测电缆终端阻性负载（新方案）
  * GND---待测负载---电缆---B点---50Ω---A点---比较器---STM32输出方波的IO
  * A点（比较器输出） - PB0（v1，ADC1-IN8）
  * B点（50Ω的另一端） - PB1（v2，ADC1-IN9）
  * 待测负载 = 50Ω*v2 / (v1-v2)

* 利用ADC+串联分压原理测电缆终端阻性负载（旧方案）
  * GND---待测负载---电缆---B点---50Ω---A点---STM32输出方波的IO
  * A点（STM32输出方波的IO） - PB0（v1，ADC1-IN8）
  * B点（50Ω的另一端） - PB1（v2，ADC1-IN9）
  * 待测负载 = 50Ω*v2 / (v1-v2)
